# SPDX-FileCopyrightText: 2020 Volker Krause <vkrause@kde.org>
# SPDX-FileCopyrightText: 2022 Stefan Gerlach <stefan.gerlach@uni.kn>
# SPDX-License-Identifier: CC0-1.0

include:
# currently fails linking test to libpoppler
  - https://invent.kde.org/sysadmin/ci-utilities/raw/master/gitlab-templates/linux.yml
#  - https://invent.kde.org/sysadmin/ci-utilities/raw/master/gitlab-templates/linux-qt6.yml
#  uses Qt6 already?
  - https://invent.kde.org/sysadmin/ci-utilities/raw/master/gitlab-templates/freebsd.yml
  #- https://invent.kde.org/sysadmin/ci-utilities/raw/master/gitlab-templates/windows.yml
# fails in final steps
#  - https://invent.kde.org/sysadmin/ci-utilities/raw/master/gitlab-templates/flatpak.yml

windows_qt515:
  stage: build
  image: kdeorg/windows-msvc2019-qt515:latest
  tags:
    - Windows
  variables:
    KDECI_CACHE_PATH: C:/Gitlab/Artifacts/windows-qt5.15/
    KDECI_GITLAB_SERVER: https://invent.kde.org/
    KDECI_PACKAGE_PROJECT: teams/ci-artifacts/windows-qt5.15
    CRAFT_ROOT: C:/Craft/windows-msvc2019_64-cl/
    CXX: cl.exe
    CC: cl.exe
    PYTHONUTF8: 1
  interruptible: true
  before_script:
    - git clone https://invent.kde.org/sysadmin/ci-utilities
    - git clone https://invent.kde.org/sysadmin/repo-metadata ci-utilities/repo-metadata/
  script:
    - . ci-utilities/resources/setup-msvc-env.ps1
    - python -u ci-utilities/run-ci-build.py --project $CI_PROJECT_NAME --branch $CI_COMMIT_REF_NAME --platform Windows/Qt5/Shared
  artifacts:
    expire_in: 2 weeks
    when: on_success
    #paths:
    #  - _install
    reports:
      junit: JUnitTestResults.xml

ubuntu_22.04_min:
  stage: build
  image: ubuntu:22.04
  only:
#    - merge_requests
    - master
  before_script:
    - apt update
    - apt install --yes eatmydata
    - eatmydata apt install --yes --no-install-recommends locales-all ninja-build git cmake make g++ extra-cmake-modules libqt5svg5-dev libkf5kio-dev libkf5archive-dev libkf5crash-dev libkf5newstuff-dev libkf5doctools-dev libkf5textwidgets-dev kuserfeedback-dev bison libgsl-dev pkg-config ca-certificates zlib1g-dev
  script:
    - mkdir -p build && cd build
    - cmake -DCMAKE_BUILD_TYPE=Debug -G Ninja ..
    - ninja
#    - ctest -V

ubuntu_22.04_full:
  stage: build
  image: ubuntu:22.04
  only:
#    - merge_requests
    - master
  before_script:
    - apt update
    - apt install --yes eatmydata
    - eatmydata apt install --yes --no-install-recommends locales-all ninja-build git cmake g++ extra-cmake-modules libqt5svg5-dev libkf5kio-dev libkf5archive-dev libkf5crash-dev libkf5newstuff-dev libkf5doctools-dev libkf5textwidgets-dev kuserfeedback-dev bison libgsl-dev libkf5parts-dev libkf5syntaxhighlighting-dev cantor libcantor-dev libpoppler-qt5-dev libfftw3-dev libreadstat-dev liborigin2-dev libhdf5-dev libnetcdf-dev libqt5serialport5-dev libcfitsio-dev libcerf-dev liblz4-dev libmatio-dev libmarkdown2-dev libspectre-dev qtbase5-private-dev ca-certificates
  script:
    - mkdir -p build && cd build
      # downloading QXlsx is not working: disable xlsx support
    - cmake -DCMAKE_BUILD_TYPE=Debug -DENABLE_EXCEL=OFF -G Ninja ..
    - ninja
#    - ctest -V

fedora_36_min:
  stage: build
  image: fedora:36
  only:
#    - merge_requests
    - master
  before_script:
    - dnf -y --setopt=install_weak_deps=False install git gcc-c++ make bison shared-mime-info cmake ninja-build wayland-devel gsl-devel qt5-qtbase-devel qt5-qtsvg-devel qt5-qtwayland-devel extra-cmake-modules kf5-ki18n-devel kf5-kio-devel kf5-knewstuff-devel kf5-karchive-devel kf5-kcrash-devel kf5-kdoctools-devel kf5-kiconthemes-devel kf5-ktextwidgets-devel kuserfeedback-devel zlib-devel
  script:
    - mkdir -p build && cd build
    - cmake -DCMAKE_BUILD_TYPE=Debug -G Ninja ..
    - ninja
#    - ctest -V

fedora_36_full:
  stage: build
  image: fedora:36
  only:
#   - merge_requests
    - master
  before_script:
    - dnf -y --setopt=install_weak_deps=False install git gcc-c++ make bison shared-mime-info cmake ninja-build wayland-devel gsl-devel qt5-qtbase-devel qt5-qtsvg-devel qt5-qtwayland-devel extra-cmake-modules kf5-ki18n-devel kf5-kio-devel kf5-knewstuff-devel kf5-karchive-devel kf5-kcrash-devel kf5-kdoctools-devel kf5-kiconthemes-devel kf5-ktextwidgets-devel kuserfeedback-devel kf5-kparts-devel kf5-syntax-highlighting-devel cantor-devel poppler-qt5-devel libspectre-devel liborigin-devel fftw3-devel netcdf-devel qt5-qtserialport-devel cfitsio-devel libcerf-devel lz4-devel matio-devel discount
  script:
    - mkdir -p build && cd build
    - cmake -G Ninja ..
    - ninja
# tests currently fail due to gcc 12?
#    - ninja test

# copied from okular
clang_format:
  stage: build
  image: debian:testing
  before_script:
    - apt-get update
    - apt-get install --yes --no-install-recommends git clang-format-13
  script: |
    ./cl-fmt.sh
    git diff --exit-code
