# SPDX-FileCopyrightText: 2020 Volker Krause <vkrause@kde.org>
# SPDX-License-Identifier: CC0-1.0

include:
  - https://invent.kde.org/sysadmin/ci-utilities/raw/master/gitlab-templates/linux.yml
#  - https://invent.kde.org/sysadmin/ci-utilities/raw/master/gitlab-templates/linux-qt6.yml
  - https://invent.kde.org/sysadmin/ci-utilities/raw/master/gitlab-templates/freebsd.yml
  - https://invent.kde.org/sysadmin/ci-utilities/raw/master/gitlab-templates/windows.yml

fedora_36_min:
  stage: build
  image: fedora:36
  only:
    - merge_requests
    - master
  before_script:
    - dnf -y --setopt=install_weak_deps=False install git gcc-c++ make bison shared-mime-info cmake ninja-build gsl-devel qt5-qtbase-devel qt5-qtsvg-devel extra-cmake-modules kf5-ki18n-devel kf5-kio-devel kf5-knewstuff-devel kf5-karchive-devel kf5-kcrash-devel kf5-kdoctools-devel kf5-kiconthemes-devel kf5-ktextwidgets-devel kuserfeedback-devel
  script:
    - mkdir -p build && cd build
    - cmake -G Ninja ..
    - ninja
    - ninja test

# copied from okular
clang_format:
  stage: build
  image: debian:testing
  only:
    - merge_requests
    - master
  before_script:
    - apt-get update
    - apt-get install --yes --no-install-recommends git clang-format-13
  script: |
    FOLDERS=("src/backend" "src/commonfrontend" "src/kdefrontend" "src/tools" "tests")
    FMT="clang-format-13"
    function format() {
        for f in $(find $@ -name '*.h' ! -iname 'getRSS.h' -or -name '*.c' -or -name '*.cpp'); do
            echo "format ${f}";
            ${FMT} -i ${f};
        done

        echo "~~~ $@ Done ~~~";
    }
    for dir in ${FOLDERS[@]}; do
        if [ ! -d "${dir}" ]; then
            echo "${dir} is not a directory";
        else
            format ${dir};
        fi
    done
    git diff --exit-code
